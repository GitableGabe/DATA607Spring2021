---
title: "DATA607 Week 9 Assignment"
author: "Gabriel Campos"
date: "`r format(Sys.Date(), '%B %d %Y')`"
output: 
  html_document:
    includes:
      in_header: header.html
    css: ./lab.css
    highlight: pygments
    theme: cerulean
    toc: true
    toc_float: true
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, results = "hold")
library(dplyr)
library(ggplot2)
library(gutenbergr)
library(janeaustenr)
library(reactable)
library(reshape2)
library(stringr)
library(textdata)
library(tidyr)
library(tidytext)
library(wordcloud)
```

Overview
========

**Week 10 Assignment**

Attached Files:

[Week 10 Assignment Rubric.pdf (45.194 KB)](https://bbhosted.cuny.edu/bbcswebdav/pid-54556511-dt-content-rid-425095250_1/xid-425095250_1)\newline

* In *Text Mining with R*, [Chapter 2 looks at Sentiment Analysis](https://www.tidytextmining.com/sentiment.html).  In this assignment, you should start by     getting the primary example code from chapter 2 working in an R Markdown document.  You should provide a
  citation to this base code.  You’re then asked to extend the code in two ways:
*	Work with a different corpus of your choosing, and
*	Incorporate at least one additional sentiment lexicon (possibly from another R package that you’ve found
  through research).

$As\ usual,\ please\ submit\ links\ to\ both\ an\ .Rmd\ file\ posted\ in\ your\ GitHub\ repository\ and\ to\ your\ code\ on\ rpubs.com.$\newline $\ You\ make\ work\ on\ a\ small\ team\ on\ this\ assignment.$

# Primary example code from Chapter 2 {.tabset .tabset-pills} 

## 2.1

**The `sentiments` datasets **


```{r, results='hold'}
get_sentiments("afinn")
```

```{r, results='hold'}
get_sentiments("bing")
```

```{r, results='hold'}
get_sentiments("nrc")
```

## 2.2

**Sentiment analysis with inner join**

```{r}
tidy_books <-
  austen_books() %>%
    group_by(book) %>%
      mutate(linenumber = row_number(),
              chapter = 
               cumsum(str_detect(text,
                      regex("^chapter [\\divxlc]",
                        ignore_case = TRUE)))) %>%
                                          ungroup() %>%
                                            unnest_tokens(word, text)
```

```{r, results='hold'}
nrc_joy <- 
  get_sentiments("nrc") %>% 
    filter(sentiment == "joy")

tidy_books %>%
  filter(book == "Emma") %>%
    inner_join(nrc_joy) %>%
      count(word, sort = TRUE)
```

```{r}
jane_austen_sentiment <- 
  tidy_books %>%
    inner_join(get_sentiments("bing")) %>%
      count(book,index = linenumber %/% 80,sentiment) %>%
        pivot_wider(names_from = sentiment,values_from = n,
                                          values_fill = 0) %>% 
          mutate(sentiment = positive - negative)
```

```{r}
ggplot(jane_austen_sentiment, aes(index, sentiment, fill = book)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~book, ncol = 2, scales = "free_x")
```

## 2.3

**Comparing the three sentiment dictionaries**

```{r, results='hold'}
pride_prejudice <- 
  tidy_books %>% 
    filter(book == "Pride & Prejudice")
```

```{r}
afinn <- pride_prejudice %>% 
  inner_join(get_sentiments("afinn")) %>% 
      group_by(index = linenumber %/% 80) %>% 
          summarise(sentiment = sum(value)) %>% 
            mutate(method = "AFINN")
```

```{r}
bing_and_nrc <- 
  bind_rows(pride_prejudice %>% 
    inner_join(get_sentiments("bing")) %>%
      mutate(method = "Bing et al."),
              pride_prejudice %>% 
                inner_join(get_sentiments("nrc") %>% 
                  filter(sentiment %in% c("positive", 
                                           "negative"))
                                                  ) %>%
                                mutate(method = "NRC")) %>%
        count(method, index = linenumber %/% 80, sentiment) %>%
                                pivot_wider(names_from = sentiment,
                                            values_from = n,
                                            values_fill = 0) %>% 
                                              mutate(sentiment = positive - negative)
```


```{r}
bind_rows(afinn, 
          bing_and_nrc) %>%
            ggplot(aes(index, sentiment, fill = method)) +
            geom_col(show.legend = FALSE) +
            facet_wrap(~method, ncol = 1, scales = "free_y")
```

```{r}
get_sentiments("nrc") %>% 
  filter(sentiment %in% c("positive", "negative")) %>% 
    count(sentiment)
```

```{r}
get_sentiments("bing") %>% 
  count(sentiment)
```

## 2.4

**Most common positive and negative words**

```{r}
bing_word_counts <- tidy_books %>%
  inner_join(get_sentiments("bing")) %>%
    count(word, sentiment, sort = TRUE) %>%
      ungroup()
```

```{r}
bing_word_counts %>%
  group_by(sentiment) %>%
    slice_max(n, n = 10) %>% 
      ungroup() %>%
        mutate(word = reorder(word, n)) %>%
          ggplot(aes(n, word, fill = sentiment)) +
          geom_col(show.legend = FALSE) +
          facet_wrap(~sentiment, scales = "free_y") +
          labs(x = "Contribution to sentiment",
          y = NULL)
```

```{r}
custom_stop_words <- 
  bind_rows(tibble(word = c("miss"),  
            lexicon = c("custom")), 
            stop_words)
```

## 2.5

**Wordclouds**

```{r}
tidy_books %>%
  anti_join(stop_words) %>%
    count(word) %>%
      with(wordcloud(word,
                     n,
                     max.words = 100))
```

```{r}
tidy_books %>%
  inner_join(get_sentiments("bing")) %>%
    count(word, sentiment, sort = TRUE) %>%
      acast(word ~ sentiment, value.var = "n", fill = 0) %>%
        comparison.cloud(colors = c("gray20"
                                    , "gray80"),
                          max.words = 100)
```

## 2.6

**Looking at units beyond just words**

```{r}
p_and_p_sentences <- 
  tibble(text = prideprejudice) %>% 
  unnest_tokens(sentence,
                text,
                token = "sentences")
```

```{r}
p_and_p_sentences$sentence[2]
```

```{r}
austen_chapters <- 
  austen_books() %>%
    group_by(book) %>%
      unnest_tokens(chapter,
                    text,
                    token = "regex", 
                    pattern = "Chapter|CHAPTER [\\dIVXLC]") %>%
                      ungroup()

austen_chapters %>% 
  group_by(book) %>% 
    summarise(chapters = n())
```

```{r}
bingnegative <-
  get_sentiments("bing") %>% 
  filter(sentiment == "negative")

wordcounts <- tidy_books %>%
  group_by(book, chapter) %>%
    summarize(words = n())

tidy_books %>%
  semi_join(bingnegative) %>%
    group_by(book, chapter) %>%
      summarize(negativewords = n()) %>%
      left_join(wordcounts, by = c("book", "chapter")) %>%
        mutate(ratio = negativewords/words) %>%
          filter(chapter != 0) %>%
            slice_max(ratio, n = 1) %>% 
              ungroup()
```

# Different Data

In order to conduct a sentiment analysis I will select have to select a novel from the `gutenbergr` package. its fields can be shown below.

```{r, echo=FALSE}
names(gutenberg_metadata)%>%kableExtra::kbl(col.names = c("gutenberg fields"))%>%kableExtra::kable_styling()
```

```{r}

gutenberg_metadata %>%
            select(gutenberg_id, title, gutenberg_bookshelf) %>%
              filter(gutenberg_id>0)%>%
               rename(id = gutenberg_id, subject = gutenberg_bookshelf)%>%
          reactable(
            bordered = TRUE,
            striped = TRUE,
            highlight = TRUE,
            filterable = TRUE,
            showPageSizeOptions = TRUE,
            showPagination = TRUE,
            columns = list(
                    id      = colDef(minWidth = 50),
                    title   = colDef(minWidth = 400),
                    subject = colDef(minWidth = 200)
                    ),
          fullWidth = TRUE,
          defaultPageSize = 5)

```


Conclusion
==========
